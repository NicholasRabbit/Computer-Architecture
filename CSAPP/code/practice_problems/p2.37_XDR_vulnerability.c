# include<stdio.h>


/*
 * CSAPP: Page 92
 *
 * Trying to solve the security vulnerability in the XDR code.
 *
 * */

// mimic/imitate the function malloc.
void malloc(int size)
{
	// ...
}


// A wrong solution.
int copy_elements(int ele_cnt, size_t ele_size) 
{
	// The original buggy code in a Sun system.
	//long long unsigned asize = ele_cnt * ele_size;

	// The wrong solution.
	long long unsigned asize = ele_cnt * (long long unsigned) ele_size;
	malloc(asize);
}



/*
 * What is wrong with the wrong solution above?
 * The argument of 'malloc' is 32-bit data type, so even if "ele_size" is cast to unsigned to avoid overflowing 
 * the 'asize' is eventually cast to an int data(32 bit).
 * */
// The following code is the correct solution.
int copy_elements_s(int ele_cnt, size_t ele_size)
{
	long long unsigned required_size = ele_cnt * (long long unsigned)ele_size;
	size_t request_size = (size_t)required_size;
	if (required_size != request_size) 
		// Overflow must have occured here, then the operation should be aborted.
		return NULL;

	void *result = malloc(request_size);
	if (result == NULL) 
		return NULL;
}
